<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTU Result Fetcher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Simple scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">VTU Bulk Result Fetcher</h1>
            <p class="text-lg text-gray-400">Enter USNs, import, or just start fetching.</p>
        </div>

        <!-- Input Section -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                
                <!-- Text Area -->
                <div class="flex-grow">
                    <label for="usn_text" class="block text-sm font-medium text-gray-300 mb-2">
                        USNs (one per line or comma-separated)
                    </label>
                    <textarea id="usn_text" rows="10" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md shadow-inner text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1GD22CS001, 1GD22CS002..."></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex-shrink-0 flex flex-row md:flex-col justify-start md:w-40 gap-4">
                    <button id="import_button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Import CSV
                    </button>
                    <button id="start_button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Start Fetching
                    </button>
                    <!-- --- [NEW] Download Button --- -->
                    <button id="download_button" style="display: none;" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Download Excel
                    </button>
                    <!-- ------------------------- -->
                </div>
            </div>
        </div>

        <!-- Log Output Section -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6">
            <h2 class="text-2xl font-semibold text-white mb-4">Log Output</h2>
            <pre id="log" class="w-full h-96 bg-gray-900 rounded-md p-4 overflow-y-auto text-sm text-gray-300 border border-gray-700 whitespace-pre-wrap break-words">Welcome! Click 'Import CSV' or 'Start Fetching'.</pre>
        </div>

    </div>

    <script>
        // --- Socket.IO Connection ---
        const socket = io();
        
        // --- Get UI Elements ---
        const usnText = document.getElementById('usn_text');
        const importButton = document.getElementById('import_button');
        const startButton = document.getElementById('start_button');
        const downloadButton = document.getElementById('download_button'); // <-- [NEW]
        const log = document.getElementById('log');

        let isRunning = false;

        // --- Helper: Log to UI ---
        function logToScreen(message) {
            log.textContent += message;
            log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
        }

        // --- Set Button States ---
        function setRunningState(running) {
            isRunning = running;
            if (running) {
                startButton.disabled = true;
                importButton.disabled = true;
                downloadButton.style.display = 'none'; // <-- [NEW] Hide on run
                startButton.textContent = "Running...";
            } else {
                startButton.disabled = false;
                importButton.disabled = false;
                startButton.textContent = "Start Fetching";
            }
        }

        // --- Button Click Handlers ---
        
        // 1. Import Button
        importButton.addEventListener('click', () => {
            logToScreen("Importing from students.csv...\n");
            socket.emit('import-csv');
        });

        // 2. Start Button
        startButton.addEventListener('click', () => {
            log.textContent = ""; // Clear log
            setRunningState(true);
            
            const usnInput = usnText.value.trim();
            // Split by comma or newline, filter out empty lines
            const usns = usnInput.replace(/,/g, '\n').split('\n').map(usn => usn.trim()).filter(usn => usn.length > 0);

            if (usns.length === 0) {
                logToScreen("Error: No USNs to process. Please enter or import USNs.\n");
                setRunningState(false);
                return;
            }
            
            // Send the list of USNs to the server
            socket.emit('start-fetch', { usns: usns });
        });

        // 3. Download Button
        downloadButton.addEventListener('click', () => {
            logToScreen("Starting download...\n");
            // This just navigates to the download URL, triggering the browser download
            window.location.href = '/download';
        });

        // --- Socket.IO Event Listeners ---

        // A. Received CSV data from server
        socket.on('csv-data', (data) => {
            usnText.value = data.usns;
        });

        // B. Received a log message from server
        socket.on('log-message', (msg) => {
            logToScreen(msg.data);
        });

        // C. Server confirms process started
        socket.on('fetch-started', () => {
            setRunningState(true);
        });

        // D. Server confirms process is complete
        socket.on('fetch-complete', () => {
            setRunningState(false);
        });
        
        // E. [NEW] Server confirms file is ready
        socket.on('download-ready', () => {
            logToScreen("\n[Info] Results file is ready for download.\n");
            downloadButton.style.display = 'block'; // Show the button
        });
        
    </script>

</body>
</html>